import services.ServiceFactory
import utilities.{ServiceConfCompleter, DiscoveryService, RequestExecutor}

import scala.util.parsing.json.JSON


/**
 * Created by cnavarro on 13/07/16.
 */
class ServiceConfCompleterTest extends UnitSpec {

  "An url substitution" should "have the correct escaping" in {
    assertResult("http://localhost:8080/api/?i=algo+que+haya+que+%3F+escapar+%2B+y+tal&lang=es&algo=EmoTextANEW"){
      val inputMap: Map[String, Any] = Map("text"->"algo que haya que ? escapar + y tal", "lang"->"es")
      val urlParameters="api/?i=${text}&lang=${lang}&algo=EmoTextANEW"
      ServiceConfCompleter.completeUrl("localhost",8080, urlParameters, inputMap)
    }
  }

  "A service completer with a json" should "be completed correctly" in {
    assertResult("""{"texto": "@Kutxabank Cobráis puntuales el seguro de hogar pero tardáis meses en atender una reparación. Sólo así se puede hac… https://t.co/hDiyCnIVaQ", "id": 8.4620578079793152E17, "favorite_count": 0.0, "synonym_found": "@Kutxabank", "retweeted": false, "coordinates": "null", "timestamp_ms": "1490586154542",			"retweet_count": 0.0,	"favorited": false, "project_name": "Kutxabank", "user": {	"screen_name": "ideasanonimas" }, "geo": null, "lang": "es", "project_id": 1.0, "created_at": "1.0", "place": null }""") {
      val input = "{\"contributors\": null, \"truncated\": true, \"text\": \"@Kutxabank Cobr\\u00e1is puntuales el seguro de hogar pero tard\\u00e1is meses en atender una reparaci\\u00f3n. S\\u00f3lo as\\u00ed se puede hac\\u2026 https://t.co/hDiyCnIVaQ\", \"is_quote_status\": false, \"in_reply_to_status_id\": null, \"id\": 846205780797931520, \"favorite_count\": 0, \"source\": \"<a href=\\\"http://twitter.com\\\" rel=\\\"nofollow\\\">Twitter Web Client</a>\", \"synonym_found\": \"@Kutxabank\", \"retweeted\": false, \"coordinates\": null, \"timestamp_ms\": \"1490586154542\", \"entities\": {\"user_mentions\": [{\"id\": 326808955, \"indices\": [0, 10], \"id_str\": \"326808955\", \"screen_name\": \"Kutxabank\", \"name\": \"Kutxabank\"}], \"symbols\": [], \"hashtags\": [], \"urls\": [{\"url\": \"https://t.co/hDiyCnIVaQ\", \"indices\": [117, 140], \"expanded_url\": \"https://twitter.com/i/web/status/846205780797931520\", \"display_url\": \"twitter.com/i/web/status/8\\u2026\"}]}, \"in_reply_to_screen_name\": \"Kutxabank\", \"id_str\": \"846205780797931520\", \"display_text_range\": [0, 140], \"retweet_count\": 0, \"in_reply_to_user_id\": 326808955, \"favorited\": false, \"project_name\": \"Kutxabank\", \"user\": {\"follow_request_sent\": null, \"profile_use_background_image\": true, \"default_profile_image\": false, \"id\": 84521847, \"verified\": false, \"profile_image_url_https\": \"https://pbs.twimg.com/profile_images/666318863177486336/ZiMXrzX6_normal.jpg\", \"profile_sidebar_fill_color\": \"DDEEF6\", \"profile_text_color\": \"333333\", \"followers_count\": 1884, \"profile_sidebar_border_color\": \"C0DEED\", \"id_str\": \"84521847\", \"profile_background_color\": \"C0DEED\", \"listed_count\": 80, \"profile_background_image_url_https\": \"https://abs.twimg.com/images/themes/theme1/bg.png\", \"utc_offset\": 10800, \"statuses_count\": 8148, \"description\": \"Periodista y cuentista, valga la redundancia. Periodista en @TVE y https://t.co/SVtbqCHL9I. 1\\u00ba libro como cuentista: A veces llega silbando (Arte Activo)\", \"friends_count\": 3507, \"location\": \"Vitoria. Basque Country. \", \"profile_link_color\": \"1DA1F2\", \"profile_image_url\": \"http://pbs.twimg.com/profile_images/666318863177486336/ZiMXrzX6_normal.jpg\", \"following\": null, \"geo_enabled\": true, \"profile_banner_url\": \"https://pbs.twimg.com/profile_banners/84521847/1367469507\", \"profile_background_image_url\": \"http://abs.twimg.com/images/themes/theme1/bg.png\", \"name\": \"Jos\\u00e9 Manuel C\\u00e1mara\", \"lang\": \"es\", \"profile_background_tile\": false, \"favourites_count\": 246, \"screen_name\": \"ideasanonimas\", \"notifications\": null, \"url\": \"http://euskizofrenia.blogspot.com\", \"created_at\": \"Fri Oct 23 06:27:42 +0000 2009\", \"contributors_enabled\": false, \"time_zone\": \"Athens\", \"protected\": false, \"default_profile\": true, \"is_translator\": false}, \"geo\": null, \"in_reply_to_user_id_str\": \"326808955\", \"possibly_sensitive\": false, \"lang\": \"es\", \"project_id\": 1, \"extended_tweet\": {\"display_text_range\": [0, 140], \"entities\": {\"user_mentions\": [{\"id\": 326808955, \"indices\": [0, 10], \"id_str\": \"326808955\", \"screen_name\": \"Kutxabank\", \"name\": \"Kutxabank\"}], \"symbols\": [], \"hashtags\": [], \"urls\": [], \"media\": [{\"expanded_url\": \"https://twitter.com/ideasanonimas/status/846205780797931520/photo/1\", \"display_url\": \"pic.twitter.com/50ySQ6WNOW\", \"url\": \"https://t.co/50ySQ6WNOW\", \"media_url_https\": \"https://pbs.twimg.com/media/C75TopdXkAANFaS.jpg\", \"id_str\": \"846205737781137408\", \"sizes\": {\"small\": {\"h\": 680, \"resize\": \"fit\", \"w\": 476}, \"large\": {\"h\": 960, \"resize\": \"fit\", \"w\": 672}, \"medium\": {\"h\": 960, \"resize\": \"fit\", \"w\": 672}, \"thumb\": {\"h\": 150, \"resize\": \"crop\", \"w\": 150}}, \"indices\": [141, 164], \"type\": \"photo\", \"id\": 846205737781137408, \"media_url\": \"http://pbs.twimg.com/media/C75TopdXkAANFaS.jpg\"}]}, \"extended_entities\": {\"media\": [{\"expanded_url\": \"https://twitter.com/ideasanonimas/status/846205780797931520/photo/1\", \"display_url\": \"pic.twitter.com/50ySQ6WNOW\", \"url\": \"https://t.co/50ySQ6WNOW\", \"media_url_https\": \"https://pbs.twimg.com/media/C75TopdXkAANFaS.jpg\", \"id_str\": \"846205737781137408\", \"sizes\": {\"small\": {\"h\": 680, \"resize\": \"fit\", \"w\": 476}, \"large\": {\"h\": 960, \"resize\": \"fit\", \"w\": 672}, \"medium\": {\"h\": 960, \"resize\": \"fit\", \"w\": 672}, \"thumb\": {\"h\": 150, \"resize\": \"crop\", \"w\": 150}}, \"indices\": [141, 164], \"type\": \"photo\", \"id\": 846205737781137408, \"media_url\": \"http://pbs.twimg.com/media/C75TopdXkAANFaS.jpg\"}]}, \"full_text\": \"@Kutxabank Cobr\\u00e1is puntuales el seguro de hogar pero tard\\u00e1is meses en atender una reparaci\\u00f3n. S\\u00f3lo as\\u00ed se puede hacer dinero? Y el servicio? https://t.co/50ySQ6WNOW\"}, \"created_at\": \"Mon Mar 27 03:42:34 +0000 2017\", \"filter_level\": \"low\", \"in_reply_to_status_id_str\": null, \"place\": null}"
      val inputJson = JSON.parseFull(input).asInstanceOf[Option[Map[String,Any]]].get
      val parameteredString = """{"texto": "${text}", "id": ${id}, "favorite_count": ${favorite_count}, "synonym_found": "${synonym_found}", "retweeted": ${retweeted}, "coordinates": "${coordinates}", "timestamp_ms": "${timestamp_ms}",			"retweet_count": ${retweet_count},	"favorited": ${favorited}, "project_name": "${project_name}", "user": {	"screen_name": "${user.screen_name}" }, "geo": ${geo}, "lang": "${lang}", "project_id": ${project_id}, "created_at": "${project_id}", "place": ${place} }"""
      val result = ServiceConfCompleter.completeString(parameteredString, inputJson, false)
      JSON.parseFull(result).asInstanceOf[Option[Map[String,Any]]]
      result

    }

  }

  }
